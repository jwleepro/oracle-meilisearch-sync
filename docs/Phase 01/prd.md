# PRD: Oracle-Meilisearch 동기화 시스템

## 1. 개요

### 1.1 배경
현재 시스템은 Oracle 11g를 주 데이터베이스로 사용하고 있습니다. 데이터 양이 증가함에 따라 다음과 같은 문제가 발생하고 있습니다:

- **대규모 조회 시 Oracle DB 과부하**: 복잡한 검색 쿼리 실행 시 DB 리소스 점유율 급증
- **전문 검색(Full-text Search) 성능 저하**: LIKE 연산자 기반 검색의 한계로 응답 속도 지연
- **복잡한 검색 조건 처리 어려움**: 다중 필드 검색, 오타 허용 검색 등 고급 검색 기능 부재

### 1.2 목표
Meilisearch를 검색 전용 엔진으로 도입하여 Oracle DB의 검색 부하를 분산하고, 빠르고 유연한 검색 경험을 제공합니다.

---

## 2. 시스템 아키텍처

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Application   │────▶│   Meilisearch    │◀────│   Sync Agent    │
│     (검색)      │     │   (검색 엔진)     │     │   (동기화)      │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                         │
                        ┌──────────────────┐              │
                        │   Oracle 11g     │◀─────────────┘
                        │   (원본 데이터)   │
                        └──────────────────┘
```

### 2.1 구성 요소

| 구성 요소 | 역할 |
|-----------|------|
| **Oracle 11g** | 원본 데이터 저장소 (SSOT: Single Source of Truth) |
| **Meilisearch** | 검색 전용 엔진 (읽기 최적화) |
| **Sync Agent** | Oracle → Meilisearch 데이터 동기화 담당 |
| **Application** | 검색 요청을 Meilisearch로 라우팅 |

---

## 3. 데이터 범위

### 3.1 동기화 대상 테이블

| 테이블명 | 설명 | 예상 레코드 수 |
|----------|------|----------------|
| **CRASIVTTST** | 주요 검색 대상 테이블 | 약 200만 건 |

### 3.2 데이터 규모

- **총 테이블 수**: 1개
- **총 레코드 수**: 약 2,000,000 건
- **예상 인덱스 크기**: TBD (스키마 분석 후 산정)

---

## 4. 기능 요구사항

### 4.1 데이터 동기화

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-01 | 초기 전체 데이터 동기화(Full Sync) 지원 | P0 |
| FR-02 | 실시간/준실시간 증분 동기화(Incremental Sync) 지원 | P0 |
| FR-03 | 동기화 실패 시 재시도 및 알림 기능 | P1 |
| FR-04 | 동기화 상태 모니터링 및 로깅 | P1 |
| FR-05 | 데이터 삭제 동기화 지원 (Soft Delete 포함) | P0 |

### 4.2 검색 기능

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-06 | 전문 검색(Full-text Search) 지원 | P0 |
| FR-07 | 오타 허용 검색(Typo Tolerance) 지원 | P1 |
| FR-08 | 필터링 및 정렬 기능 | P0 |
| FR-09 | 페이지네이션 지원 | P0 |
| FR-10 | 하이라이팅(검색어 강조) 기능 | P2 |

### 4.3 관리 기능

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| FR-11 | 인덱스 설정 관리 (검색 가능 필드, 정렬 필드 등) | P1 |
| FR-12 | 동기화 스케줄 관리 | P1 |
| FR-13 | 수동 동기화 트리거 기능 | P2 |

---

## 5. 비기능 요구사항

### 5.1 성능

| ID | 요구사항 | 목표값 |
|----|----------|--------|
| NFR-01 | 검색 응답 시간 | < 50ms (95 percentile) |
| NFR-02 | 동기화 지연 시간 | < 5초 (증분 동기화) |
| NFR-03 | 동시 검색 요청 처리 | 1,000 RPS 이상 |

### 5.2 안정성

| ID | 요구사항 | 목표값 |
|----|----------|--------|
| NFR-04 | 서비스 가용성 | 99.9% |
| NFR-05 | 데이터 정합성 | 99.99% (Oracle과 동기화) |
| NFR-06 | 장애 복구 시간 | < 30분 |

### 5.3 확장성

| ID | 요구사항 |
|----|----------|
| NFR-07 | 수평 확장 가능한 아키텍처 |
| NFR-08 | 신규 테이블/인덱스 추가 용이성 |

### 5.4 보안

| ID | 요구사항 | 설명 |
|----|----------|------|
| NFR-09 | API 인증 | Meilisearch API Key 기반 인증 적용 |
| NFR-10 | 네트워크 보안 | 내부 네트워크(Private Network) 전용 접근 |
| NFR-11 | 민감 데이터 처리 | 개인정보 포함 필드는 인덱싱 제외 또는 마스킹 처리 |

---

## 6. 동기화 전략

### 6.1 증분 동기화 방식

Oracle 11g의 CDC 기능 제한으로 인해 **타임스탬프 기반 폴링 방식**을 채택합니다.

| 항목 | 설정값 | 비고 |
|------|--------|------|
| 변경 감지 방식 | 타임스탬프 컬럼 (UPDATED_AT) 기반 폴링 | 인덱스 필수 |
| 폴링 주기 | 3초 | 설정 파일에서 조정 가능 |
| 배치 크기 | 1,000건 | 메모리 사용량 고려 |

### 6.2 Soft Delete 처리

| 항목 | 설명 |
|------|------|
| 삭제 플래그 컬럼 | `IS_DELETED` (Y/N) 또는 `DELETE_YN` |
| 삭제 시간 컬럼 | `DELETED_AT` (NULL이면 미삭제) |
| 동기화 동작 | 삭제 플래그가 'Y'이거나 DELETED_AT이 NOT NULL인 경우 Meilisearch에서 문서 삭제 |

### 6.3 동시성 제어

| 시나리오 | 처리 방식 |
|----------|-----------|
| Full Sync 중 서비스 | 새 인덱스에 동기화 후 Alias 전환 (Zero Downtime) |
| 동기화-검색 동시 수행 | Meilisearch 내부 락 활용 (읽기는 항상 허용) |
| 다중 Sync Agent | 단일 인스턴스 운영 권장, 필요시 리더 선출 방식 |

---

## 7. 장애 대응

### 7.1 페일오버 시나리오

| 상황 | 감지 방법 | 전환 방식 | 복구 조건 |
|------|-----------|-----------|-----------|
| Meilisearch 장애 | Health Check 실패 (3회 연속) | **자동 전환** → Oracle 직접 검색 | Health Check 성공 (5회 연속) |
| 동기화 지연 | 지연 시간 > 임계값 (30초) | 알림 발송, 수동 판단 | 지연 시간 정상화 |
| 데이터 불일치 | 주기적 카운트 비교 | 알림 발송 → 수동 Full Sync | Full Sync 완료 |

### 7.2 복구 절차

1. **자동 복구**: Sync Agent 재시작 시 마지막 동기화 시점부터 재개
2. **수동 복구**: 관리 API를 통한 Full Sync 트리거
3. **데이터 정합성 검증**: 정기적인 레코드 수 비교 및 샘플링 검증

---

## 8. 기술 스택

| 영역 | 기술 | 선택 근거 |
|------|------|-----------|
| 검색 엔진 | Meilisearch | 빠른 응답 속도, 쉬운 설정, 오타 허용 검색 내장 |
| 원본 DB | Oracle 11g | 기존 시스템 |
| 동기화 에이전트 | **Go** | 높은 동시성 처리, 낮은 메모리 사용, 단일 바이너리 배포 용이 |
| 배포 환경 | Docker / Kubernetes | 컨테이너 기반 확장성 |

### 8.1 기술 스택 선택 기준 (Sync Agent)

| 언어 | 장점 | 단점 | 적합도 |
|------|------|------|--------|
| **Go** | 고성능, 낮은 리소스, 단일 바이너리 | Oracle 드라이버 설정 복잡 | **선택** |
| Java | Oracle 드라이버 안정적, 엔터프라이즈 생태계 | 높은 메모리 사용량, 무거운 배포 | 차선 |
| Python | 빠른 개발, 간단한 코드 | GIL로 인한 동시성 제한, 상대적 저성능 | 프로토타입용 |

---

## 9. 제약 사항

- Oracle 11g 버전 제약으로 인해 CDC(Change Data Capture) 기능 사용 불가
- Meilisearch는 쓰기 작업에 최적화되지 않음 → 검색 전용으로 사용
- 원본 데이터는 항상 Oracle에서 관리 (SSOT 원칙)

---

## 10. 마일스톤

| 단계 | 내용 | 예상 기간 |
|------|------|-----------|
| Phase 1 | 기본 동기화 및 검색 기능 구현 | 4주 |
| Phase 2 | 모니터링 및 알림 시스템 구축 | 2주 |
| Phase 3 | 성능 최적화 및 부하 테스트 | 2주 |
| Phase 4 | 운영 환경 배포 및 안정화 | 2주 |

---

## 11. 성공 지표

- Oracle DB 검색 관련 쿼리 부하 **70% 이상 감소**
- 평균 검색 응답 시간 **90% 개선**
- 사용자 검색 만족도 향상 (전문 검색 기능 제공)

---

## 12. 리스크 및 대응 방안

| 리스크 | 영향도 | 대응 방안 |
|--------|--------|-----------|
| 동기화 지연으로 인한 데이터 불일치 | 높음 | 상태 모니터링 및 자동 복구 메커니즘 |
| Meilisearch 장애 시 검색 불가 | 높음 | 폴백(Fallback)으로 Oracle 직접 검색 (자동 전환) |
| 대용량 초기 동기화 시 성능 저하 | 중간 | 배치 처리 및 비동기 처리 |
| Go Oracle 드라이버 호환성 이슈 | 중간 | godror 라이브러리 사용, 사전 PoC 검증 |
